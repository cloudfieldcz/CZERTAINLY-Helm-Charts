{{- $redisPassword := pluck "password" .Values.global.redis .Values.redis | compact | first | default "" }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "caching-redis.fullname" . }}-test-connection"
  labels:
    {{- include "caching-redis.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: redis-test
      image: {{ include "caching-redis.image" . }}
      command:
        - /bin/sh
        - -c
        - |
          {{- if $redisPassword }}
          redis-cli -h {{ include "caching-redis.fullname" . }} -a "{{ $redisPassword }}" ping | grep -q PONG
          {{- else }}
          redis-cli -h {{ include "caching-redis.fullname" . }} ping | grep -q PONG
          {{- end }}
  restartPolicy: Never
